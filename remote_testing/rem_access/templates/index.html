{% load staticfiles %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-3.2.1.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/css/bootstrap-slider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/bootstrap-slider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.min.js"></script>
    <link rel='stylesheet' href='{% static "css/style.css" %}'/>
    <style>
        #   ex1Slider .slider-selection {
                background: #BABABA;
            }
            #content {
                width: 880px;
                margin: 0 auto;
                padding: 10px;
            }
            .demo-container {
                box-sizing: border-box;
                width: 425px;
                height: 225px;
                /*padding: 20px 15px 15px 15px;*/
                /*margin: 15px auto 30px auto;*/
                border: 1px solid #ddd;
                background: #fff;
                background: linear-gradient(#f6f6f6 0, #fff 50px);
                background: -o-linear-gradient(#f6f6f6 0, #fff 50px);
                background: -ms-linear-gradient(#f6f6f6 0, #fff 50px);
                background: -moz-linear-gradient(#f6f6f6 0, #fff 50px);
                background: -webkit-linear-gradient(#f6f6f6 0, #fff 50px);
                box-shadow: 0 3px 10px rgba(0,0,0,0.15);
                -o-box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                -ms-box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                -moz-box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                -webkit-box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }

            .demo-placeholder {
                width: 100%;
                height: 100%;
                font-size: 14px;
                line-height: 1.2em;
            }

            .legend table {
                border-spacing: 5px;
            }
            .sup {
              position: relative;
              bottom: 1ex;
              font-size: 80%;
            }
    </style>
</head>
<body>
    <div class="row">
        <div class="col-sm-9">
            <div class="col-sm-6">
                <h3>Sollwert Position</h3>
                <div id="content_1">
                    <div class="demo-container">
                        <div id="placeholder_1" class="demo-placeholder"></div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <h3>Istwert Position</h3>
                <div id="content_2">
                    <div class="demo-container">
                        <div id="placeholder_2" class="demo-placeholder"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-3">
            <br/>
            <h3>Position:</h3><br />
            <input class="from-control" id="position" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="14"/>
            <br />
            <a href='https://hostingkartinok.com/show-image.php?id=04a90ceb817b0fc53b33570f907635af'  title='picture hosting'><img style="width:100%;margin-left:-15%;" src='https://s8.hostingkartinok.com/uploads/images/2017/05/04a90ceb817b0fc53b33570f907635af.jpg' /></a>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-9">
            <div class="col-sm-6">
                <h3>Beschleunigung</h3>
                <div id="content_3">
                    <div class="demo-container">
                        <div id="placeholder_3" class="demo-placeholder"></div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <h3>Strom</h3>
                <div id="content_4">
                    <div class="demo-container">
                        <div id="placeholder_4" class="demo-placeholder"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-3"></div>
    </div>
</body>
<script>
    $(function () {

        String.prototype.replaceAll = function (str1, str2, ignore) {
            return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g, "\\$&"), (ignore ? "gi" : "g")), (typeof(str2) == "string") ? str2.replace(/\$/g, "$$$$") : str2);
        };
        var ws = new WebSocket("ws://localhost:6544");

        var data = {},
			totalPoints = 100;
        for (var t = 0;  t < 4; t++){
            var arr = [];
            for (var i = 0; i < totalPoints; ++i) {
                arr.push([i, 0]);
            }
            data[t] = arr;
        }
        console.log(data);
        // вызовется, когда соединение будет установлено:
        ws.onopen = function() {
            console.log('connect')
        };

        // вызовется, когда соединение закроется
        ws.onclose = function() {
            console.log('close');
        };

        // вызовется, когда браузер получает какие-то данные через веб-сокет
        ws.onmessage = function(evt) {
            //console.log(evt.data);
            var datas = JSON.parse(evt.data.replaceAll("'", '"'));
            getData(datas);
        };
        var call = false;
        // slider setup
        var _position = $("#position");
        _position.slider({
            formatter: function(value) {
                return 'Current value: ' + value;
            }
        });
        _position.bind("slideStop", function (e) {
            console.log(e.value);
            ws.send(JSON.stringify('send_data ' + e.value));
            if (!call)
            {
                ws.send(JSON.stringify('get_data'));
                call = true;
            }
        });
        //setInterval(SockData, 1000);
        //function SockData(){
        //    console.log('send_Data');
        //    ws.send(JSON.stringify('get_data'));
        //};
        jQuery(window).bind(
            "beforeunload",
            function() {
                message = 'get_data';
                ws.close();
               // ws.send(JSON.stringify(message));
            }
        );
        // We use an inline data source in the example, usually data would
		// be fetched from a server



		function getData(datas) {

            var i = 0,
                dataNew = {};

            for (var t = 0;  t < 4; t++){
                var arr = [];
                for (var i = 0; i < totalPoints-1; ++i) {
                    arr.push([i, data[t][i+1][1]]);
                }
                dataNew[t] = arr;
            }
            for (var t = 0; t < 4; t++){
                var arr = dataNew[t]
                arr.push([totalPoints - 1, datas.data[t]]);
                dataNew[t] = arr;
            }
            data = {};
            data = dataNew;
		}

		// Set up the control widget

//		var updateInterval = 30;
//		$("#updateInterval").val(updateInterval).change(function () {
//			var v = $(this).val();
//			if (v && !isNaN(+v)) {
//				updateInterval = +v;
//				if (updateInterval < 1) {
//					updateInterval = 1;
//				} else if (updateInterval > 2000) {
//					updateInterval = 2000;
//				}
//				$(this).val("" + updateInterval);
//			}
//		});

		var plot1 = $.plot("#placeholder_1", [ data[0] ], {
			series: {
				shadowSize: 0	// Drawing is faster without shadows
			},
			yaxis: {
				min: -100,
				max: 100
			},
			xaxis: {
				show: true
			}
		});
        var plot2 = $.plot("#placeholder_2", [ data[1] ], {
			series: {
				shadowSize: 0	// Drawing is faster without shadows
			},
			yaxis: {
				min: -100,
				max: 100
			},
			xaxis: {
				show: true
			}
		});
        var plot3 = $.plot("#placeholder_3", [ data[2] ], {
			series: {
				shadowSize: 0	// Drawing is faster without shadows
			},
			yaxis: {
				min: -100,
				max: 100
			},
			xaxis: {
				show: true
			}
		});
        var plot4 = $.plot("#placeholder_4", [ data[3] ], {
			series: {
				shadowSize: 0	// Drawing is faster without shadows
			},
			yaxis: {
				min: -1000,
				max: 1000
			},
			xaxis: {
				show: true
			}
		});


		function update() {
			plot1.setData([data[0]]);
			plot2.setData([data[1]]);
			plot3.setData([data[2]]);
			plot4.setData([data[3]]);

			// Since the axes don't change, we don't need to call plot.setupGrid()

			plot1.draw();
			plot2.draw();
			plot3.draw();
			plot4.draw();
			setTimeout(update, 40);
		}

		update();

		// Add the Flot version string to the footer

		$("#footer").prepend("Flot " + $.plot.version + " &ndash; ");

    });
</script>
</html>
